<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>생산설계</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css"
      integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      * {
        background-color: #cee3f6;
        margin: 0;
        padding: 0;
        /* border: 1px solid; */
        box-sizing: border-box;
      }

      .center {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .container-fluid {
        padding-right: 15px;
        padding-left: 15px;
        margin-right: auto;
        margin-left: auto;
      }
      #header {
        height: 100px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        gap: 10px;
      }
      #header img {
        height: 80px;
        width: 105px;
        margin-left: 0px;
      }
      #nav {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #cee3f6;
        color: black;
        padding: 10px;
      }
      ul {
        text-decoration: none;
        list-style: none;
      }
      ul li {
        display: inline;
      }

      h2 {
        color: #0e0342;
        font-size: 32px;
        font-weight: bold;
        height: 100%;
        line-height: 1.2;
        align-content: center;
        margin-bottom: 0px;
      }
      .custom-button {
        background-color: #0e0342;
        color: white;
        padding: 5px 20px;
        border-radius: 20px;
        border: 3px solid black;
        margin-left: 30px;
        cursor: pointer;
        font-weight: bold;
      }
      /* Add this CSS to change the background color when selected */
      .collection-item.selected {
        background-color: white; /* Background color when selected */
        border-radius: 5px;
      }

      .custom-button:hover {
        background-color: #0e0342;
        color: white;
        text-decoration: underline;
      }

      .nav-tabs .nav-item .nav-link {
        color: black;
        border-radius: 15px;
        padding: 10px 20px;
        margin-right: 10px;
        font-weight: bold;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .nav-tabs .nav-item .nav-link.active {
        background-color: #3a285e;
        color: white;
      }

      .nav-tabs .nav-item .nav-link:hover {
        background-color: #4b386f;
        color: white;
      }

      .nav-tabs {
        border-bottom: none;
      }

      #aside {
        border-right: 5px solid #3a285e;
        padding: 15px;
        height: 650px;
        margin-bottom: 15px;
      }

      #section {
        padding-left: 15px;
      }

      #table-container {
        max-height: 460px;
        overflow-y: auto;
        position: relative;
        width: 100%;
        display: flex;
        justify-content: center; /* 테이블을 수평으로 가운데 정렬 */
        scrollbar-gutter: stable; /* 스크롤바 공간을 항상 확보 */
        border-bottom: solid 3px #84bdf3;
      }

      #welcome-message {
        display: inline-block;
        border-bottom: 1px solid;
        padding-bottom: 4px;
      }
      .accordion-body a {
        color: black;
        text-decoration: none;
      }
      .collection-link {
        background-color: transparent;
        border: 0px;
      }
      .accordion-body ul {
        display: flex;
        flex-direction: column;
      }
      .accordion-item {
        margin-bottom: 10px;
      }
      .accordion-body li {
        flex: 1;
      }
      .aside-link {
        text-decoration: none;
        color: black;
      }
      ul li:hover {
        background-color: #e0f2f7;
        border-radius: 5px;
      }
      ul li a {
        display: block;
        padding: 10px 20px;
        text-decoration: none;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }

      .add-button {
        background-color: #6c757d;
        color: white;
        font-size: 1rem;
        border-radius: 0.25rem;
        border: 1px solid transparent;
        display: inline-block;
        height: 38px;
        margin-top: 27.5px;
        border-radius: 7px;
      }

      .add-button:hover {
        background-color: #5a6268;
      }
      #data-table {
        width: 100%; /* 테이블 너비 전체 설정 */
        table-layout: fixed; /* 고정된 열 너비 */
        border-collapse: separate; /*셀 테두리와 내용 간에 간격을 줌*/
      }

      /* 표 색상 변경 */
      #data-table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: center; /* 텍스트 가운데 정렬 */
        vertical-align: middle;
        border: 1px solid #0e0342; /* 셀 테두리 설정 */
        border-radius: 5px; /*  셀 테두리 라운드 */
        white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        overflow: hidden; /* 텍스트가 넘칠 경우 숨기기 */
        text-overflow: ellipsis; /* 넘치는 텍스트를 ...으로 표시 */
        background-color: #0e0342; /* 원하는 색상으로 변경 */
        color: white; /* 텍스트 색상을 흰색으로 변경 */
        font-weight: bold;
      }
      #data-table tbody td {
        text-align: center; /* 텍스트 가운데 정렬 */
        vertical-align: middle;
        border: 1px solid #0e0342; /* 셀 테두리 설정 */
        border-radius: 5px; /*  셀 테두리 라운드 */
        white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        overflow: hidden; /* 텍스트가 넘칠 경우 숨기기 */
        text-overflow: ellipsis; /* 넘치는 텍스트를 ...으로 표시 */
        padding: 8px; /* 셀 내부 패딩 */
      }

      table,
      th,
      td {
        border: 1px solid #ddd;
        border-collapse: collapse;
      }

      #data-table th:nth-child(2),
      #data-table td:nth-child(2),
      #data-table th:nth-child(3),
      #data-table td:nth-child(3) {
        width: 13%; /* D/P&BOM 코드 */
      }

      #data-table th:nth-child(4),
      #data-table td:nth-child(4),
      #data-table th:nth-child(5),
      #data-table td:nth-child(5),
      #data-table th:nth-child(7),
      #data-table td:nth-child(7) {
        width: 10%; /* 다른 열의 너비를 줄임 */
      }

      #data-table th:nth-child(8),
      #data-table td:nth-child(8),
      #data-table th:nth-child(9),
      #data-table td:nth-child(9) {
        width: 12%; /* 작업 출도계획 및 작업 출도실적 */
      }

      #data-table th:nth-child(1),
      #data-table td:nth-child(1),
      #data-table th:nth-child(6),
      #data-table td:nth-child(6),
      #data-table th:nth-child(10),
      #data-table td:nth-child(10) {
        width: 8%; /* 버튼 열의 너비 설정 */
      }

      #search-container {
        flex-grow: 1;
      }

      /* 검색창 input 필드 스타일 */
      #search-container input {
        width: 300px;
        padding: 7px;
        border: 2px solid #ccc;
        border-radius: 5px;
        outline: none;
        margin-bottom: 4px !important;
      }

      .reset-button {
        background-color: #0e0342;
        color: white;
        margin-right: 22px;
        cursor: pointer;
        border: none;
        padding: 7px;
        width: 110px;
        font-size: 16px;
        border-radius: 5px;
        font-weight: bold;
      }

      th i {
        background-color: transparent;
      }

      button img {
        width: 20px;
        height: 20px;
        display: block; /* 이미지가 보이도록 설정 */
      }

      .reset-button:hover {
        background-color: #231c46; /* 버튼 호버 시 색상 */
      }

      /* D/P&BOM내역 드롭다운 */
      #dropdownDpBom {
        width: 150px; /* D/P&BOM 내역 드롭다운 너비 설정 */
      }

      /* 설계기능 드롭다운 */
      #dropdownFunction {
        width: 120px; /* 설계기능 드롭다운 너비 설정 */
      }

      /* 도면종류 드롭다운 */
      #dropdownDrawing {
        width: 120px; /* 도면종류 드롭다운 너비 설정 */
      }

      /* 협력사 드롭다운 */
      #dropdownPartner {
        width: 100px; /* 협력사 드롭다운 너비 설정 */
      }

      /* 직영책임부서 드롭다운 */
      #dropdownDept {
        width: 150px; /* 직영책임부서 드롭다운 너비 설정 */
      }
      .breadcrumb {
        margin-bottom: 0;
        background-color: transparent; /* 배경색 제거 */
        margin-left: 45px;
        font-size: 18px;
        color: black;
        font-weight: bold;
      }
      .breadcrumb a {
        color: black;
        text-decoration: none;
      }

      .p-2.d-flex .form-control {
        max-width: calc(
          100% - 60px
        ); /* 버튼 크기를 고려해 입력 필드의 최대 너비 조정 */
      }

      .p-2.d-flex button {
        margin: 0; /* 버튼의 여백을 없애고 */
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-4">
      <div id="header">
        <div id="header-left" style="display: flex; gap: 20px">
          <a href="/">
            <img src="/img/samsung.png" alt="Logo" id="img1" />
          </a>
          <div class="center"><h2>SHI Process Condition</h2></div>
        </div>
        <div
          id="header-right"
          style="display: flex; align-items: center; gap: 20px"
        >
          <p id="welcome-message" style="margin-top: 15px">님 반갑습니다.</p>
          <button type="button" class="custom-button" onclick="logout()">
            로그아웃
          </button>
        </div>
      </div>

      <div id="nav" class="box">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link" id="tab1" href="./first">개정도 현황</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="tab2" href="./second">설계 요청 현황</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="tab3" href="./third">생산설계</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="tab4" href="./sixth">용접 현황</a>
          </li>
        </ul>
      </div>

      <nav
        style="--bs-breadcrumb-divider: ''"
        aria-label="breadcrumb"
        class="my-2"
        id="mybreadcrumb"
      >
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="./third" id="first_menu"
              ><i class="fa-solid fa-list"></i>&nbsp&nbsp&nbsp생산설계</a
            >
          </li>
          <li
            class="breadcrumb-item active"
            aria-current="page"
            id="second_menu"
          ></li>
        </ol>
      </nav>

      <div id="main" class="col-12 d-flex">
        <div id="aside" class="col-2 d-flex flex-column m-4">
          <div id="accordionGroup">
            <!-- 구조 아코디언 -->
            <div class="accordion accordion-flush" id="accordionFlushExample1">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    style="
                      box-shadow: none;
                      background-color: #cee3f6;
                      border: solid 1px #0e0342;
                      border-radius: 10px;
                      font-weight: bold;
                    "
                    data-bs-toggle="collapse"
                    data-bs-target="#flush-collapseOne1"
                    aria-expanded="false"
                    aria-controls="flush-collapseOne1"
                    data-bs-parent="#accordionGroup"
                    class="collection-link aside-link"
                    id="collection-link1"
                    onclick="loadCollections('구조생설'); menudisplay('구조', '추가하기', 'collection-link1');"
                  >
                    구조
                  </button>
                </h2>
                <div
                  id="flush-collapseOne1"
                  class="accordion-collapse collapse show"
                >
                  <div class="accordion-body m-0 p-0">
                    <ul id="collection-list-구조생설" class="m-0 p-0">
                      <!-- 구조 컬렉션 목록이 동적으로 추가될 부분 -->
                    </ul>
                    <div
                      class="p-2 d-flex justify-content-center align-items-center"
                    >
                      <input
                        type="text"
                        id="newCollectionName-구조생설"
                        class="form-control mb-2 me-2"
                        placeholder="새 프로젝트 추가"
                        style="flex: 1"
                        onclick="menudisplay('구조', '추가하기')"
                      />
                      <button
                        class="btn btn-secondary"
                        style="height: 38px"
                        onclick="addNewCollection('구조생설')"
                      >
                        추가
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 의장 아코디언 -->
            <div class="accordion accordion-flush" id="accordionFlushExample2">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    style="
                      box-shadow: none;
                      background-color: #cee3f6;
                      border: solid 1px #0e0342;
                      border-radius: 10px;
                      font-weight: bold;
                    "
                    data-bs-toggle="collapse"
                    data-bs-target="#flush-collapseOne2"
                    aria-expanded="false"
                    aria-controls="flush-collapseOne2"
                    data-bs-parent="#accordionGroup"
                    class="collection-link aside-link"
                    id="collection-link2"
                    onclick="loadCollections('의장생설'); menudisplay('의장', '추가하기', 'collection-link2');"
                  >
                    의장
                  </button>
                </h2>
                <div
                  id="flush-collapseOne2"
                  class="accordion-collapse collapse"
                >
                  <div class="accordion-body m-0 p-0">
                    <ul id="collection-list-의장생설" class="m-0 p-0">
                      <!-- 의장 컬렉션 목록이 동적으로 추가될 부분 -->
                    </ul>
                    <div class="p-2">
                      <input
                        type="text"
                        id="newCollectionName-의장생설"
                        class="form-control mb-2"
                        placeholder="새 컬렉션명 입력"
                      />
                      <button
                        class="btn btn-secondary"
                        onclick="addNewCollection('의장생설')"
                      >
                        컬렉션 추가
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 콘텐츠가 로드될 section -->
        <div id="section" class="col-9.5">
          <h5 style="margin-top: 30px; margin-bottom: 30px; font-weight: bold">
            값을 입력해주세요.
          </h5>
          <div class="d-flex gap-3">
            <div class="mb-3">
              <label for="exampleFormControlInput1" class="form-label"
                >D/P&BOM 코드</label
              >
              <input
                type="text"
                class="form-control"
                id="exampleFormControlInput1"
                placeholder="DPBOM000000001"
              />
            </div>
            <div class="mb-3">
              <label for="exampleFormControlInput2" class="form-label"
                >작업 출도계획</label
              >
              <input
                type="text"
                class="form-control"
                id="exampleFormControlInput2"
                placeholder="2024-01-01"
              />
            </div>
            <div class="mb-3">
              <label for="exampleFormControlInput3" class="form-label"
                >작업 출도실적</label
              >
              <input
                type="text"
                class="form-control"
                id="exampleFormControlInput3"
                placeholder="2024-01-02"
              />
            </div>
            <div class="dropdown center mt-2">
              <button
                class="btn btn-secondary dropdown-toggle"
                type="button"
                id="dropdownDpBom"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                D/P&BOM내역
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#">가공</a></li>
                <li><a class="dropdown-item" href="#">공작</a></li>
                <li><a class="dropdown-item" href="#">도장</a></li>
                <li><a class="dropdown-item" href="#">의장</a></li>
                <li><a class="dropdown-item" href="#">재마킹</a></li>
                <li><a class="dropdown-item" href="#">족장</a></li>
                <li><a class="dropdown-item" href="#">철의장</a></li>
              </ul>
            </div>

            <div class="dropdown center mt-2">
              <button
                class="btn btn-secondary dropdown-toggle"
                type="button"
                id="dropdownFunction"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                설계기능
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#">F1</a></li>
                <li><a class="dropdown-item" href="#">F2</a></li>
                <li><a class="dropdown-item" href="#">F3</a></li>
                <li><a class="dropdown-item" href="#">F4</a></li>
                <li><a class="dropdown-item" href="#">F5</a></li>
                <li><a class="dropdown-item" href="#">F6</a></li>
                <li><a class="dropdown-item" href="#">F7</a></li>
              </ul>
            </div>

            <div class="dropdown center mt-2">
              <button
                class="btn btn-secondary dropdown-toggle"
                type="button"
                id="dropdownDrawing"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                도면종류
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item drawing-option" href="#">D1</a></li>
                <li><a class="dropdown-item drawing-option" href="#">D2</a></li>
                <li><a class="dropdown-item drawing-option" href="#">D3</a></li>
                <li><a class="dropdown-item drawing-option" href="#">D4</a></li>
                <li><a class="dropdown-item drawing-option" href="#">D5</a></li>
                <li><a class="dropdown-item drawing-option" href="#">D6</a></li>
                <li><a class="dropdown-item drawing-option" href="#">D7</a></li>
                <li><a class="dropdown-item drawing-option" href="#">D8</a></li>
              </ul>
            </div>
            <div class="dropdown center mt-2">
              <button
                class="btn btn-secondary dropdown-toggle"
                type="button"
                id="dropdownPartner"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                협력사
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item partner-option" href="#">D5</a></li>
                <li>
                  <a class="dropdown-item partner-option" href="#">없음</a>
                </li>
              </ul>
            </div>
            <div class="dropdown center mt-2">
              <button
                class="btn btn-secondary dropdown-toggle"
                type="button"
                id="dropdownDept"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                직영책임부서
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item dept-option" href="#">D1</a></li>
                <li><a class="dropdown-item dept-option" href="#">D3</a></li>
                <li><a class="dropdown-item dept-option" href="#">D4</a></li>
              </ul>
            </div>
            <button class="btn btn-secondary add-button" type="button">
              추가
            </button>
          </div>

          <!-- 검색창과 정렬 초기화 버튼 -->
          <div class="d-flex justify-content-between align-items-center">
            <div id="search-container" class="flex-grow-1">
              <input
                type="text"
                id="search-input"
                class="form-control search-input"
                placeholder="D/P&BOM 코드 검색"
                onkeyup="filterTable()"
              />
            </div>
            <!-- 정렬 초기화 버튼 오른쪽 끝에 맞추기 -->
            <div>
              <button class="reset-button" onclick="resetTable()">
                정렬 초기화
              </button>
            </div>
          </div>
          <div id="table-container">
            <table id="data-table" class="table table-striped">
              <thead>
                <tr>
                  <th>프로젝트</th>
                  <th>D/P&BOM 코드</th>
                  <th>D/P&BOM 내역</th>
                  <th>설계기능</th>
                  <th>도면종류</th>
                  <th>협력사</th>
                  <th>직영책임부서</th>
                  <th onclick="toggleSort(7)" class="sortable">
                    작업 출도계획 <i class="fa fa-sort"></i>
                  </th>
                  <th onclick="toggleSort(8)" class="sortable">
                    작업 출도실적 <i class="fa fa-sort"></i>
                  </th>
                  <th>완료 버튼</th>
                </tr>
              </thead>
              <tbody>
                <!-- 필터링된 데이터가 이곳에 출력됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      function menudisplay(menu1, menu2) {
        const first_menu = document.getElementById("first_menu");
        const second_menu = document.getElementById("second_menu");
        const mybreadcrumb = document.getElementById("mybreadcrumb");

        // 첫 번째 메뉴를 항상 "생산설계"로 설정
        first_menu.innerHTML = `<i class="fa-solid fa-list"></i> &nbsp;&nbsp;생산설계`;

        // 두 번째 메뉴가 있을 때만 갱신
        if (menu1) {
          second_menu.innerText = `${menu1} >> ${menu2}`;
          mybreadcrumb.style.setProperty("--bs-breadcrumb-divider", "'>>'");
        } else {
          second_menu.innerText = ""; // 메뉴가 없을 때는 텍스트 비움
          mybreadcrumb.style.setProperty("--bs-breadcrumb-divider", "''");
        }

        // 브레드크럼 보이게 설정
        mybreadcrumb.style.visibility = "visible";
      }

      async function addNewCollection(dbName) {
        const collectionInput = document.getElementById(
          `newCollectionName-${dbName}`
        );
        const newCollectionName = collectionInput.value.trim();

        if (!newCollectionName) {
          alert("컬렉션명을 입력하세요.");
          return;
        }

        try {
          const response = await fetch("/api/add-collection", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              dbName: dbName,
              collectionName: newCollectionName,
            }),
          });

          const result = await response.json();
          if (response.ok) {
            alert("컬렉션이 성공적으로 추가되었습니다.");
            collectionInput.value = ""; // 입력창 초기화
            loadCollections(dbName); // 추가 후 목록 갱신
          } else {
            alert(
              `컬렉션 추가 중 오류 발생: ${result.message} - ${result.error}`
            ); // 오류 메시지와 함께 세부 오류 내용도 출력
          }
        } catch (error) {
          console.error("컬렉션 추가 중 오류:", error);
          alert("서버 오류가 발생했습니다.");
        }
      }
    </script>

    <!-- 사용자 정보를 가져와서 환영 메시지 표시 -->
    <script>
      // 서버에서 사용자 정보를 가져와 환영 메시지에 표시
      fetch("/user-info")
        .then((response) => response.json())
        .then((data) => {
          if (data.name) {
            document.getElementById(
              "welcome-message"
            ).textContent = `${data.name}님 반갑습니다.`;
          }
        })
        .catch((err) => {
          console.error("사용자 정보를 가져오는 중 오류 발생:", err);
        });
    </script>

    <!-- 로그아웃 버튼 기능 -->
    <script>
      // 로그아웃 함수: 로그아웃 클릭 시 로그아웃 페이지로 이동
      function logout() {
        localStorage.removeItem("welcomeShown"); // 환영 메시지 상태 초기화
        localStorage.removeItem("activeTab"); // 탭 상태 초기화
        location.href = "/logout"; // 로그아웃 요청
      }
    </script>

    <!-- 아코디언 내 링크 클릭 시 기본 동작 방지 및 아코디언 유지 -->
    <script>
      let selectedLink = null;
      let selectedDB = null;
      let selectedCollection = null;
      let selectedProject = null;
      let sortOrder = {};

      // 기존에 클릭 이벤트를 개별적으로 등록하던 부분을 이벤트 위임 방식으로 변경
      document.addEventListener("DOMContentLoaded", function () {
        // DB와 컬렉션 선택 이벤트 위임
        document
          .querySelector("#accordionGroup")
          .addEventListener("click", function (event) {
            const target = event.target;

            // 선택된 요소가 collection-link 클래스인지 확인
            if (target.classList.contains("collection-link")) {
              event.preventDefault(); // 기본 링크 동작 막기

              // 이전에 선택된 링크가 있으면 selected 클래스를 제거
              if (selectedLink) {
                selectedLink.classList.remove("selected");
              }

              // 새로 클릭된 링크에 selected 클래스를 추가하고 현재 선택된 링크로 설정
              target.classList.add("selected");
              selectedLink = target;

              // 선택된 DB와 컬렉션 저장
              selectedDB = target.getAttribute("data-db");
              selectedCollection = target.getAttribute("data-collection");

              // 프로젝트 값 설정 (P1, P2, P3 중 하나)
              selectedProject = target.textContent.trim();

              // 로그 출력 확인
              console.log("선택된 프로젝트:", selectedProject);
              console.log("선택된 DB:", selectedDB);
              console.log("선택된 Collection:", selectedCollection);

              // DB와 컬렉션이 선택된 후에 데이터를 불러옴
              loadFilteredData();
            }
          });
      });

      // 드롭다운에서 선택된 텍스트를 업데이트하는 함수
      function updateDropdownText(dropdownButton, text) {
        dropdownButton.textContent = text;
      }

      // 모든 드롭다운에서 선택된 값을 메인 버튼에 표시
      document.querySelectorAll(".dropdown").forEach(function (dropdown) {
        const dropdownButton = dropdown.querySelector(".dropdown-toggle");
        const dropdownItems = dropdown.querySelectorAll(".dropdown-item");

        dropdownItems.forEach(function (item) {
          item.addEventListener("click", function (event) {
            event.preventDefault(); // 기본 링크 동작만 막음
            const selectedText = event.target.textContent;
            updateDropdownText(dropdownButton, selectedText);
          });
        });
      });

      document.querySelectorAll(".dropdown-item").forEach((item) => {
        item.addEventListener("click", function (event) {
          event.preventDefault();
          const selectedText = event.target.textContent;
          const dropdownButton = item
            .closest(".dropdown")
            .querySelector(".dropdown-toggle");
          dropdownButton.textContent = selectedText; // 선택된 텍스트 표시
        });
      });

      // 추가 버튼 클릭 시 데이터를 서버로 전송하고, 테이블을 새로고침
      document
        .querySelector(".add-button")
        .addEventListener("click", async function (event) {
          event.preventDefault(); // 기본 동작을 막음

          // DB와 컬렉션이 선택되었는지 확인
          if (!selectedDB || !selectedCollection) {
            alert("DB와 컬렉션을 선택하세요.");
            return;
          }

          // 프로젝트가 선택되었는지 확인
          if (!selectedProject) {
            alert("프로젝트를 선택하세요.");
            return;
          }

          // 입력 값 가져오기
          const dpBomCode = document
            .querySelector("#exampleFormControlInput1")
            .value.trim();

          const workPlan = document
            .querySelector("#exampleFormControlInput2")
            .value.trim();

          const workResult = document
            .querySelector("#exampleFormControlInput3")
            .value.trim();

          const workResultValue = workResult
            ? new Date(workResult).toISOString()
            : null;

          const dpBom = document
            .querySelector("#dropdownDpBom")
            .textContent.trim();
          const designFunction = document
            .querySelector("#dropdownFunction")
            .textContent.trim();
          const drawingType = document
            .querySelector("#dropdownDrawing")
            .textContent.trim();
          const partner = document
            .querySelector("#dropdownPartner")
            .textContent.trim();
          const responsibilityDepartment = document
            .querySelector("#dropdownDept")
            .textContent.trim();

          // 서버로 보낼 데이터 객체 생성
          const data = {
            db: selectedDB,
            collection: selectedCollection,
            project: selectedProject, // 프로젝트 값을 포함
            dpBomCode,
            workPlan,
            workResult: workResultValue,
            dpBom,
            designFunction,
            drawingType,
            partner,
            responsibilityDepartment,
          };

          // 데이터가 제대로 준비되었는지 로그로 확인
          console.log("전송할 데이터: ", data);

          try {
            const response = await fetch("/api/add-entry", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            const result = await response.json();
            if (response.ok) {
              alert("데이터가 성공적으로 추가되었습니다.");

              // 데이터가 성공적으로 추가된 후 테이블을 새로고침
              loadFilteredData(); // 테이블 새로고침 함수 호출
            } else {
              alert("데이터 추가 중 오류가 발생했습니다: " + result.message);
            }
          } catch (error) {
            console.error("데이터 전송 중 오류:", error);
            alert("서버 오류가 발생했습니다.");
          }
        });

      async function loadFilteredData() {
        if (!selectedDB || !selectedCollection) {
          alert("DB와 컬렉션을 선택하세요.");
          return;
        }

        try {
          const response = await fetch(
            `/api/get-filtered-data?dbName=${selectedDB}&collectionName=${selectedCollection}`
          );
          const data = await response.json();

          // 데이터를 제대로 받아왔는지 확인
          console.log("받아온 데이터: ", data);

          // 테이블에 데이터를 출력
          const tableBody = document.querySelector("#data-table tbody");
          tableBody.innerHTML = ""; // 테이블 초기화

          data.forEach((item) => {
            const row = document.createElement("tr");

            // 작업 출도실적 or 출도실적이 null인 경우 버튼 추가할 변수
            const resultData = item["작업 출도실적"] || item["출도실적"];
            let buttonCellContent = "";

            if (!resultData) {
              // 데이터가 null인 경우 완료버튼 한 개 추가
              buttonCellContent = `
          <div class="center" style="display: flex; background-color: transparent">
            <button class="btn btn-secondary" onclick="updateDateTime(this, '${item._id}')">완료</button>
          </div>
        `;
            }

            // "작업 출도계획" 또는 "최종 출도가능일자"를 선택하여 출력
            const workPlanDate =
              item["작업 출도계획"] || item["최종 출도가능일자"];
            const formattedWorkPlanDate = workPlanDate
              ? new Date(workPlanDate).toLocaleDateString()
              : "";

            const formattedWorkResultDate = resultData
              ? new Date(resultData).toLocaleDateString()
              : "";

            // row에 데이터를 연월일로 추가
            row.innerHTML = `
        <td>${item.프로젝트 || ""}</td>
        <td>${item["D/P&BOM 코드"] || ""}</td>
        <td>${item["D/P&BOM 내역"] || ""}</td>
        <td>${item.설계기능 || ""}</td>
        <td>${item.도면종류 || ""}</td>
        <td>${item.협력사 || ""}</td>
        <td>${item.직영책임부서 || ""}</td>
        <td>${formattedWorkPlanDate}</td> <!-- 작업 출도계획 또는 최종 출도가능일자 -->
        <td>${formattedWorkResultDate}</td> <!-- 작업 출도실적 연월일 -->
        <td>${buttonCellContent}</td> <!-- 버튼을 출력하는 새 열 -->
      `;

            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("데이터를 가져오는 중 오류 발생:", error);
        }
      }
      function toggleSort(columnIndex) {
        // 현재 정렬 상태를 가져와서 asc 또는 desc로 토글
        const currentOrder = sortOrder[columnIndex] || "asc";
        const newOrder = currentOrder === "asc" ? "desc" : "asc";

        // 정렬 상태 업데이트
        sortOrder[columnIndex] = newOrder;

        // 테이블 데이터를 정렬하는 함수 호출
        sortTable(columnIndex, newOrder);

        // 정렬 아이콘 업데이트
        updateSortIcon(columnIndex, newOrder);
      }

      function updateSortIcon(columnIndex, order) {
        // 모든 정렬 아이콘을 기본 상태로 초기화
        document.querySelectorAll("th i").forEach((icon) => {
          icon.classList.remove("fa-sort-up", "fa-sort-down", "fa-sort");
          icon.classList.add("fa-sort"); // 기본 아이콘으로 초기화
        });

        // 선택된 열의 아이콘을 오름차순 또는 내림차순으로 변경
        const columnHeader = document.querySelectorAll("th")[columnIndex];
        const icon = columnHeader.querySelector("i");
        if (order === "asc") {
          icon.classList.remove("fa-sort");
          icon.classList.add("fa-sort-up");
        } else {
          icon.classList.remove("fa-sort");
          icon.classList.add("fa-sort-down");
        }
      }

      function sortTable(columnIndex, order) {
        const table = document.getElementById("data-table");
        const rows = Array.from(table.querySelectorAll("tbody tr"));

        // 행을 정렬
        rows.sort((a, b) => {
          const aText = a
            .querySelector(`td:nth-child(${columnIndex + 1})`)
            .textContent.trim();
          const bText = b
            .querySelector(`td:nth-child(${columnIndex + 1})`)
            .textContent.trim();

          // 날짜 포맷을 맞추어 정렬 (YYYY-MM-DD 기준)
          const aDate = new Date(aText);
          const bDate = new Date(bText);

          // asc와 desc에 따라 정렬 순서를 결정
          if (order === "asc") {
            return aDate - bDate;
          } else {
            return bDate - aDate;
          }
        });

        // 정렬된 행을 다시 테이블에 추가
        rows.forEach((row) => table.querySelector("tbody").appendChild(row));
      }

      function resetTable() {
        // 기본 정렬 상태로 되돌림
        sortOrder = {};

        // 정렬 아이콘 초기화
        document.querySelectorAll("th i").forEach((icon) => {
          icon.classList.remove("fa-sort-up", "fa-sort-down");
          icon.classList.add("fa-sort");
        });

        // 테이블을 기본 상태로 다시 로드
        loadFilteredData();
      }
    </script>

    <script>
      async function updateDateTime(button, documentId) {
        const now = new Date(); // 현재 날짜 및 시간
        const formattedDate = now.toISOString(); // ISO 형식으로 변환

        const row = button.closest("tr");
        const projectId = row.querySelector("td:nth-child(1)").textContent; // 프로젝트 ID
        const collectionName = selectedCollection; // 선택된 컬렉션 이름
        const dbName = selectedDB; // 선택된 데이터베이스 이름

        try {
          const response = await fetch("/api/completion", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              projectId: projectId,
              documentId: documentId,
              completionDate: formattedDate, // 현재 날짜 전송
              collectionName: collectionName,
              dbName: dbName, // 데이터베이스 이름도 함께 전송
            }),
          });

          const data = await response.json();

          if (response.ok) {
            if (data.updatedRecord) {
              // 서버에서 받은 완료 시간을 연월일만 표시하도록 수정
              const completionDate = new Date(
                data.updatedRecord["작업 출도실적"]
              );

              // 받은 날짜가 유효한지 확인하고 연월일만 표시
              if (!isNaN(completionDate.getTime())) {
                row.querySelector("td:nth-child(9)").textContent =
                  completionDate.toLocaleDateString(); // 연월일만 표시
              } else {
                row.querySelector("td:nth-child(9)").textContent =
                  "Invalid Date";
              }

              // 완료 버튼 숨기기
              button.style.display = "none";
              loadFilteredData();
            }
          } else {
            alert("업데이트 중 오류가 발생했습니다: " + data.message);
          }
        } catch (error) {
          console.error("업데이트 중 오류 발생:", error);
          alert("서버와 통신 중 오류가 발생했습니다.");
        }
      }

      function loadSavedData() {
        var rows = document.querySelectorAll("table tbody tr");

        rows.forEach(function (row) {
          var projectId = row.querySelector("td:nth-child(1)").textContent;

          // 서버에서 저장된 완료 시간을 가져옴 (GET 요청)
          console.log("Fetching data for projectId:", projectId);

          fetch("/api/completion/" + projectId)
            .then((response) => {
              console.log("Response status:", response.status);
              return response.json();
            })
            .then((data) => {
              console.log("Fetched data:", data); // 여기서 데이터가 제대로 오는지 확인
              if (data.completionDate) {
                console.log("Loaded completionDate:", data.completionDate); // 불러온 날짜 확인
                var outputCell = row.querySelector("td:nth-child(9)");
                outputCell.textContent = new Date(
                  data.completionDate
                ).toLocaleString();

                // 완료 시간이 있으면 버튼 숨김
                var button = row.querySelector("button");
                if (button) {
                  button.style.display = "none";
                }
              }
            })
            .catch((error) => {
              console.error("데이터 불러오기 중 오류 발생:", error);
            });
        });
      }

      // 페이지 로드 시 데이터 불러오기
      window.addEventListener("DOMContentLoaded", function () {
        console.log("Page loaded, calling loadSavedData");
        loadSavedData();
      });

      function filterTable() {
        const input = document
          .getElementById("search-input")
          .value.toUpperCase();
        const table = document.getElementById("data-table");
        const tr = table.getElementsByTagName("tr");

        // 각 행을 반복하며 D/P&BOM 코드 열을 기준으로 필터링
        for (let i = 1; i < tr.length; i++) {
          const td = tr[i].getElementsByTagName("td")[1]; // D/P&BOM 코드가 있는 두 번째 열
          if (td) {
            const txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(input) > -1) {
              tr[i].style.display = ""; // 검색어와 일치하면 표시
            } else {
              tr[i].style.display = "none"; // 검색어와 일치하지 않으면 숨김
            }
          }
        }
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // 페이지가 로드될 때 기존의 컬렉션 목록을 불러옵니다.
        loadCollections("구조생설");
        loadCollections("의장생설");
      });

      // 컬렉션 목록을 불러와서 collection-link와 aside-link 클래스를 추가
      async function loadCollections(dbName) {
        const collectionList = document.getElementById(
          `collection-list-${dbName}`
        );
        if (!collectionList) return;

        try {
          const response = await fetch(
            `/api/get-collections?dbName=${encodeURIComponent(dbName)}`
          );
          const collections = await response.json();

          // 컬렉션 목록을 <li>로 렌더링하며, 삭제 버튼 추가
          collectionList.innerHTML = collections
            .map((collection) => {
              const displayMenu = dbName === "구조생설" ? "구조" : "의장";
              return `
      <li class="d-flex align-items-center justify-content-between collection-item" onclick="toggleSelected(this)">
        <a href="#" 
          onclick="menudisplay('${displayMenu}', '${collection}')" 
          class="collection-link aside-link flex-grow-1 me-2 p-2" 
          data-db="${dbName}" 
          data-collection="${collection}"
          style="display: block;">
          ${collection}
        </a>
        <button class="btn p-0" 
          style="background: url('img/can.png') no-repeat center center; 
                background-size: contain; 
                width: 24px; 
                height: 24px; 
                border: none; 
                margin-right: 10px;"
          onclick="confirmDeleteCollection('${dbName}', '${collection}')">
        </button>
      </li>
    `;
            })
            .join("");
        } catch (error) {
          console.error("Error loading collections:", error);
        }
      }
      // JavaScript function to toggle the selected class
      function toggleSelected(element) {
        document.querySelectorAll(".collection-item").forEach((item) => {
          item.classList.remove("selected");
        });
        element.classList.add("selected");
      }
      function confirmDeleteCollection(dbName, collectionName) {
        if (confirm(`${collectionName} 컬렉션을 삭제하시겠습니까?`)) {
          deleteCollection(dbName, collectionName);
        }
      }

      async function deleteCollection(dbName, collectionName) {
        try {
          const response = await fetch("/api/delete-collection", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ dbName, collectionName }),
          });

          const result = await response.json();
          if (response.ok) {
            alert("컬렉션이 삭제되었습니다.");
            loadCollections(dbName); // 컬렉션 목록 갱신
          } else {
            alert(`컬렉션 삭제 중 오류 발생: ${result.message}`);
          }
        } catch (error) {
          console.error("컬렉션 삭제 중 오류:", error);
          alert("서버 오류가 발생했습니다.");
        }
      }

      async function logout() {
        location.href = "/logout";
      }
    </script>

    <!-- 탭 활성화 상태를 로컬 스토리지에 저장하고 복원하는 기능 -->
    <script>
      // 페이지가 로드될 때 URL에 맞는 탭을 활성화
      document.addEventListener("DOMContentLoaded", function () {
        const activeTab = localStorage.getItem("activeTab");
        const currentPath = window.location.pathname;

        let tabToActivate;

        // URL 경로에 따라 적절한 탭 설정
        if (currentPath.includes("first")) {
          tabToActivate = "tab1";
        } else if (currentPath.includes("second")) {
          tabToActivate = "tab2";
        } else if (currentPath.includes("third")) {
          tabToActivate = "tab3";
        } else if (currentPath.includes("sixth")) {
          tabToActivate = "tab4";
        }

        if (tabToActivate) {
          // 모든 탭에서 active 클래스 제거
          document.querySelectorAll(".nav-link").forEach(function (tab) {
            tab.classList.remove("active");
          });
          // URL에 맞는 탭에 active 클래스 추가
          document.getElementById(tabToActivate).classList.add("active");
          localStorage.setItem("activeTab", tabToActivate); // 활성화된 탭 상태 저장
        }
      });
    </script>

    <!-- 선택된 링크 강조 및 상태 관리 -->
    <script>
      // 클릭된 항목을 추적하는 변수
      document.querySelectorAll(".collection-link").forEach(function (link) {
        link.addEventListener("click", function (event) {
          event.preventDefault(); // 기본 링크 동작 막기

          // 이전에 선택된 링크가 있으면 selected 클래스를 제거
          if (selectedLink) {
            selectedLink.classList.remove("selected");
          }

          // 새로 클릭된 링크에 selected 클래스를 추가하고 현재 선택된 링크로 설정
          link.classList.add("selected");
          selectedLink = link;
        });
      });

      // JavaScript: 클릭 시 선택된 항목 강조
      document.addEventListener("DOMContentLoaded", function () {
        const listItems = document.querySelectorAll("ul li");

        listItems.forEach((item) => {
          item.addEventListener("click", function (event) {
            // 모든 항목에서 'selected' 클래스 제거
            listItems.forEach((li) => li.classList.remove("selected"));

            // 클릭된 항목에 'selected' 클래스 추가
            this.classList.add("selected");
          });
        });
      });
    </script>

    <!-- 드롭다운에서 선택한 값을 버튼에 표시하는 기능 -->
    <script>
      // D/P&BOM내역 선택 이벤트
      document.querySelectorAll(".dpbom-option").forEach(function (option) {
        option.addEventListener("click", function (event) {
          event.preventDefault();
          document.getElementById("dropdownDpBom").textContent =
            this.textContent;
        });
      });

      // 설계기능 선택 이벤트
      document.querySelectorAll(".function-option").forEach(function (option) {
        option.addEventListener("click", function (event) {
          event.preventDefault();
          document.getElementById("dropdownFunction").textContent =
            this.textContent;
        });
      });

      // 도면종류 선택 이벤트
      document.querySelectorAll(".drawing-option").forEach(function (option) {
        option.addEventListener("click", function (event) {
          event.preventDefault();
          document.getElementById("dropdownDrawing").textContent =
            this.textContent;
        });
      });

      // 협력사 선택 이벤트
      document.querySelectorAll(".partner-option").forEach(function (option) {
        option.addEventListener("click", function (event) {
          event.preventDefault();
          document.getElementById("dropdownPartner").textContent =
            this.textContent;
        });
      });

      // 직영책임부서 선택 이벤트
      document.querySelectorAll(".dept-option").forEach(function (option) {
        option.addEventListener("click", function (event) {
          event.preventDefault();
          document.getElementById("dropdownDept").textContent =
            this.textContent;
        });
      });

      document.addEventListener("DOMContentLoaded", function () {
        const dateInputs = [
          document.getElementById("exampleFormControlInput2"),
          document.getElementById("exampleFormControlInput3"),
        ];

        dateInputs.forEach((input) => {
          input.addEventListener("input", function () {
            // 숫자만 추출
            let inputVal = input.value.replace(/\D/g, "");

            // 입력된 값이 연도, 월, 일의 길이를 초과하지 않도록 자름
            if (inputVal.length > 8) {
              inputVal = inputVal.slice(0, 8);
            }

            // 형식이 맞지 않을 때 자동 교정
            if (inputVal.length > 4 && inputVal.length <= 6) {
              input.value = `${inputVal.slice(0, 4)}-${inputVal.slice(4)}`;
            } else if (inputVal.length > 6) {
              input.value = `${inputVal.slice(0, 4)}-${inputVal.slice(
                4,
                6
              )}-${inputVal.slice(6)}`;
            } else {
              input.value = inputVal; // 연도만 입력된 경우
            }
          });

          // 올바른 날짜 형식만 허용
          input.addEventListener("blur", function () {
            // 빈 값인 경우는 에러 메시지 없이 통과
            if (input.value.trim() === "") {
              return;
            }

            // 숫자만 추출하여 날짜 형식을 보정
            const inputVal = input.value.replace(/\D/g, "");
            let correctedDate = "";

            // 입력된 값의 길이에 따라 형식 보정
            if (inputVal.length >= 6) {
              const year = inputVal.slice(0, 4);
              let month = inputVal.slice(4, 6);
              let day = inputVal.slice(6, 8);

              // 월과 일이 한 자리일 경우 앞에 0을 추가
              if (month.length === 1) month = `0${month}`;
              if (day.length === 1) day = `0${day}`;

              correctedDate = `${year}-${month}-${day}`;
            }

            // 정규식을 사용하여 형식 검사 (YYYY-MM-DD)
            const datePattern =
              /^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;
            if (!datePattern.test(correctedDate)) {
              alert(
                "날짜 형식이 올바르지 않습니다. YYYY-MM-DD 형식으로 입력해주세요."
              );
              input.value = ""; // 잘못된 입력일 경우 입력 초기화
              input.focus();
            } else {
              input.value = correctedDate; // 보정된 날짜 형식 적용
            }
          });
        });
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"
      integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
