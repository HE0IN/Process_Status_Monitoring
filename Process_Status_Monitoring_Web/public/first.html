<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>개정도 현황</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css"
      integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      * {
        background-color: #cee3f6;
        margin: 0;
        padding: 0;
        /* border: 1px solid; */
        box-sizing: border-box;
      }
      body {
        background-color: #cee3f6;
      }

      .center {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #header {
        height: 100px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        gap: 10px;
      }
      #header img {
        height: 80px;
        width: 105px;
        margin-left: 0px;
      }
      #nav {
        display: flex;
        justify-content: center;
        align-items: center;
        color: black;
        padding: 10px;
      }
      .breadcrumb {
        margin-bottom: 0;
        background-color: transparent; /* 배경색 제거 */
        margin-left: 45px;
        font-size: 18px; /* 원하는 크기로 설정 */
      }

      /* first_menu의 글자 색상과 밑줄 제거 */
      #first_menu {
        color: #0e0342; /* 글자 색상을 원하는 색으로 변경 */
        text-decoration: none; /* 밑줄 제거 */
        font-weight: bold;
      }
      ul {
        text-decoration: none;
        list-style: none;
      }
      ul li {
        display: inline;
      }
      ul li a {
        display: block;
        padding: 10px 20px;
        text-decoration: none;
        border: 1px solid #ccc;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }

      ul li a:hover {
        background-color: #e0f2f7; /* 호버 시 배경색 변경 */
      }
      h2 {
        color: #0e0342;
        font-size: 32px;
        font-weight: bold;
        height: 100%;
        line-height: 1.2;
        align-content: center;
        margin-bottom: 0px;
      }
      .custom-button {
        background-color: #0e0342;
        color: white;
        padding: 5px 20px;
        border-radius: 20px;
        border: 3px solid black;
        margin-left: 30px;
        cursor: pointer;
        font-weight: bold;
      }

      .custom-button:hover {
        background-color: #0e0342;
        color: white;
        text-decoration: underline;
      }

      .nav-tabs .nav-item .nav-link {
        color: black;
        border-radius: 15px;
        padding: 10px 20px;
        margin-right: 10px;
        font-weight: bold;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .nav-tabs .nav-item .nav-link.active {
        background-color: #3a285e;
        color: white;
      }

      .nav-tabs .nav-item .nav-link:hover {
        background-color: #4b386f;
        color: white;
      }

      .nav-tabs {
        border-bottom: none;
      }

      #main {
        display: flex; /* Flexbox를 사용하여 자식 요소를 가로로 정렬 */
        align-items: flex-start; /* 위쪽에 맞추어 정렬 */
      }

      #aside {
        border-right: 5px solid #3a285e;
        padding: 15px;
        height: 650px;
        margin-bottom: 15px;
      }

      #section {
        padding-left: 15px; /* 구분선과의 간격 */
      }

      #myChart {
        width: 100%;
        height: 300px; /* 차트의 높이를 300px로 설정 */
        max-height: 400px; /* 최대 높이를 제한 */
      }

      #welcome-message {
        display: inline-block;
        border-bottom: 1px solid;
        padding-bottom: 4px;
      }
      .collection-link {
        background-color: transparent;
        border: 0px;
      }
      .accordion-body ul {
        display: flex;
        flex-direction: column;
      }
      .accordion-button {
        background-color: #cee3f6; /* 기본 배경색 */
        color: black;
        transition: background-color 0.3s ease;
      }
      .accordion-button.active {
        background-color: white; /* 아코디언이 열렸을 때 배경색을 하얀색으로 */
        color: black;
        border: 1px solid #ccc; /* 경계선 추가 */
      }
      .accordion-body li {
        flex: 1; /* 각 li 요소들이 동일한 너비를 가짐 */
      }
      .accordion-item {
        margin-bottom: 10px;
      }
      .aside-link {
        text-decoration: none;
        color: black;
      }
      .selected {
        background-color: #cee3f6;
        color: #000;
      }
      .sort-btn {
        background-color: #0e0342;
        border: none;
        cursor: pointer;
        padding-left: 5px;
      }

      .sort-btn i {
        font-size: 14px;
        color: white;
        background-color: transparent; /* 아이콘의 배경을 투명하게 설정 */
      }

      .sort-btn i.active {
        color: white;
      }

      thead th {
        background-color: #0e0342 !important;
        color: white !important;
        text-align: center;
        padding: 10px;
      }
      #dataTableContainer {
        width: 100%; /* 전체 너비 설정 */
        height: 100%; /* 최대 높이 설정 */
        overflow-y: auto; /* 세로 스크롤 활성화 */
        overflow-x: auto; /* 가로 스크롤 활성화 */
        border-collapse: collapse; /* 셀 테두리 간격 제거 */
        background-color: #f0f0f0; /* 배경색 설정 */
      }
      #dataTableContainer table {
        border-collapse: separate; /* 셀 테두리와 내용 간 간격 추가 */
      }
      #dataTableContainer th,
      #dataTableContainer td {
        text-align: center; /* 텍스트 가운데 정렬 */
        border-radius: 5px; /* 테두리 둥글게 */
        white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        overflow: hidden; /* 넘치는 텍스트 숨김 */
        text-overflow: ellipsis; /* 넘치는 텍스트를 ...으로 표시 */
        border: 1px solid #0e0342; /* 셀 테두리 설정 */
      }

      #dataTableContainer th {
        font-weight: bold; /* 헤더 폰트 굵게 */
        position: sticky; /* 헤더 고정 */
        top: 0; /* 스크롤 시에도 상단에 고정 */
        z-index: 2; /* 다른 요소 위에 표시 */
      }
      .reset-button {
        background-color: #0e0342; /* 초기화 버튼 배경색 */
        color: white;
        border: none;
        height: 50px;
        width: 110px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 15px;
      }

      .reset-button:hover {
        background-color: #231c46; /* 버튼 호버 시 색상 */
      }

      .title-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      #searchInput {
        margin-left: 690px;
        margin-top: 15px;
        height: 50px;
      }
      h4 {
        margin-bottom: 15px;
      }
      .selected {
        background-color: white;
        color: #000;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-4">
      <div id="header">
        <div id="header-left" style="display: flex; gap: 20px">
          <a href="/">
            <img src="/img/samsung.png" alt="Logo" id="img1" />
          </a>
          <div class="center"><h2>SHI Process Condition</h2></div>
        </div>
        <div
          id="header-right"
          style="display: flex; align-items: center; gap: 20px"
        >
          <p id="welcome-message" style="margin-top: 15px">님 반갑습니다.</p>
          <button type="button" class="custom-button" onclick="logout()">
            로그아웃
          </button>
        </div>
      </div>

      <div id="nav" class="box">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link" id="tab1" href="./first">개정도 현황</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="tab2" href="./second">설계 요청 현황</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="tab3" href="./third">생산설계</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="tab4" href="./sixth">용접 현황</a>
          </li>
        </ul>
      </div>

      <!-- 브레드크럼 위치 -->
      <nav
        style="--bs-breadcrumb-divider: '>>'"
        aria-label="breadcrumb"
        class="my-2"
        id="mybreadcrumb"
      >
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="./first" id="first_menu"
              ><i class="fa-solid fa-list"></i>&nbsp&nbsp&nbsp개정도 현황</a
            >
          </li>
          <li
            class="breadcrumb-item"
            id="second_menu"
            style="visibility: hidden"
          >
            <a href="#">조회</a>
          </li>
          <li
            class="breadcrumb-item active"
            aria-current="page"
            id="third_menu"
            style="visibility: hidden"
          >
            프로젝트
          </li>
        </ol>
      </nav>

      <div id="main" class="col-12">
        <div id="aside" class="col-2 d-flex flex-column m-4">
          <div id="accordionGroup">
            <!-- 조회 아코디언 -->
            <div class="accordion accordion-flush" id="accordionFlushExample2">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    style="
                      box-shadow: none;
                      background-color: #cee3f6;
                      border: solid 1px #0e0342;
                      border-radius: 10px;
                      font-weight: bold;
                    "
                    data-bs-toggle="collapse"
                    data-bs-target="#flush-collapseOne2"
                    aria-expanded="false"
                    aria-controls="flush-collapseOne2"
                    data-bs-parent="#accordionGroup"
                  >
                    조회
                  </button>
                </h2>
                <div
                  id="flush-collapseOne2"
                  class="accordion-collapse collapse"
                >
                  <div class="accordion-body m-0 p-0">
                    <ul class="m-0 p-0">
                      <li>
                        <a
                          href=""
                          data-db="개정도DB"
                          data-collection="개정도_1"
                          data-type="table"
                          class="collection-link aside-link"
                          id="collection-link1"
                          onclick="menudisplay('개정도 현황','조회','Project_1', 'collection-link1')"
                          >Project_1</a
                        >
                      </li>
                      <li>
                        <a
                          href=""
                          data-db="개정도DB"
                          data-collection="개정도_2"
                          data-type="table"
                          class="collection-link aside-link"
                          id="collection-link2"
                          onclick="menudisplay('개정도 현황','조회','Project_2', 'collection-link2')"
                          >Project_2</a
                        >
                      </li>
                      <li>
                        <a
                          href=""
                          data-db="개정도DB"
                          data-collection="개정도_3"
                          data-type="table"
                          class="collection-link aside-link"
                          id="collection-link3"
                          onclick="menudisplay('개정도 현황','조회','Project_3', 'collection-link3')"
                          >Project_3</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <!-- 원인코드 아코디언 -->
            <div class="accordion accordion-flush" id="accordionFlushExample1">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    style="
                      box-shadow: none;
                      background-color: #cee3f6;
                      border: solid 1px #0e0342;
                      border-radius: 10px;
                      font-weight: bold;
                    "
                    data-bs-toggle="collapse"
                    data-bs-target="#flush-collapseOne1"
                    aria-expanded="false"
                    aria-controls="flush-collapseOne1"
                    data-bs-parent="#accordionGroup"
                  >
                    원인코드분석
                  </button>
                </h2>
                <div
                  id="flush-collapseOne1"
                  class="accordion-collapse collapse"
                >
                  <div class="accordion-body m-0 p-0">
                    <ul class="m-0 p-0">
                      <li>
                        <a
                          href=""
                          data-db="개정도DB"
                          data-collection="개정도_1"
                          data-type="chart"
                          class="collection-link aside-link"
                          id="collection-link4"
                          onclick="menudisplay('개정도 현황','원인코드분석','Project_1', 'collection-link4')"
                          >Project_1</a
                        >
                      </li>
                      <li>
                        <a
                          href=""
                          data-db="개정도DB"
                          data-collection="개정도_2"
                          data-type="chart"
                          class="collection-link aside-link"
                          id="collection-link5"
                          onclick="menudisplay('개정도 현황','원인코드분석','Project_2', 'collection-link5')"
                          >Project_2</a
                        >
                      </li>
                      <li>
                        <a
                          href=""
                          data-db="개정도DB"
                          data-collection="개정도_3"
                          data-type="chart"
                          class="collection-link aside-link"
                          id="collection-link6"
                          onclick="menudisplay('개정도 현황','원인코드분석','Project_3', 'collection-link6')"
                          >Project_3</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="section" class="col-9">
          <div class="title-container">
            <h5 id="h5-title" style="margin-top: 30px; font-weight: bold"></h5>
            <div
              class="title-container"
              style="display: flex; align-items: center; gap: 10px"
            >
              <input
                type="text"
                id="searchInput"
                class="form-control"
                placeholder="검색어를 입력하세요"
                style="width: 200px; display: none"
                onkeyup="searchTable()"
              />
              <button class="reset-button" onclick="resetTable()">
                정렬 초기화
              </button>
            </div>
          </div>

          <!-- 여기 테이블이 동적으로 삽입될 예정 -->
          <div
            id="loadingMessage"
            style="
              display: none;
              text-align: center;
              font-size: 18px;
              font-weight: bold;
            "
          >
            로딩 중...
          </div>
          <div
            id="dataTableContainer"
            style="max-height: 550px; overflow-y: auto"
          ></div>
          <p
            id="total-count"
            style="font-weight: bold; font-size: 18px; text-align: center"
          ></p>
          <canvas id="myChart" width="1200" height="1200"></canvas>
          <!-- 경고/주의 부서 리스트 영역 -->
          <div id="alert-list" style="margin-top: 20px">
            <h4>부서별 주의/경고 사항</h4>

            <div id="warning-list" style="color: red; margin-bottom: 10px">
              <h5 id="warning-count" style="margin-left: 5px"></h5>
              <ul
                id="warning-departments"
                style="
                  color: black;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 10px;
                  list-style-type: none;
                  padding-left: 0;
                  margin-left: 10px;
                "
              >
                <!-- 경고 부서 리스트가 여기에 동적으로 삽입됩니다 -->
              </ul>
            </div>

            <div id="caution-list" style="color: blue; margin-top: 10px">
              <h5 id="caution-count" style="margin-left: 5px"></h5>
              <ul
                id="caution-departments"
                style="
                  color: black;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 10px;
                  list-style-type: none;
                  padding-left: 0;
                  margin-left: 10px;
                "
              >
                <!-- 주의 부서 리스트가 여기에 동적으로 삽입됩니다 -->
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function menudisplay(menu1, menu2, menu3, selectedlink) {
        const arrCollectionLink =
          document.getElementsByClassName("collection-link");
        for (cl of arrCollectionLink) {
          cl.classList.remove("menu_selected");
        }
        const collectionlink = document.getElementById(selectedlink);
        collectionlink.classList.add("menu_selected");

        const first_menu = document.getElementById("first_menu");
        first_menu.innerHTML = `<i class="fa-solid fa-list"></i> &nbsp&nbsp${menu1}`;

        const second_menu = document.getElementById("second_menu");
        second_menu.innerText = menu2;
        second_menu.style.visibility = "visible"; // 조회 항목 표시

        const third_menu = document.getElementById("third_menu");
        third_menu.innerText = menu3;
        third_menu.style.visibility = "visible"; // 프로젝트 항목 표시
      }
      // 서버에서 사용자 정보를 가져와서 화면에 표시
      fetch("/user-info")
        .then((response) => response.json())
        .then((data) => {
          if (data.name) {
            document.getElementById(
              "welcome-message"
            ).textContent = `${data.name}님 반갑습니다.`;
          }
        })
        .catch((err) => {
          console.error("사용자 정보를 가져오는 중 오류 발생:", err);
        });

      // 로그아웃 함수: 로그아웃 클릭 시 로그아웃 페이지로 이동
      function logout() {
        localStorage.removeItem("welcomeShown"); // 환영 메시지 상태 초기화
        localStorage.removeItem("activeTab"); // 탭 상태 초기화
        location.href = "/logout"; // 로그아웃 요청
      }
    </script>

    <!-- 탭 활성화 상태를 로컬 스토리지에 저장하고 복원하는 기능 -->
    <script>
      function createTable(data) {
        // 테이블의 헤더를 정의 (출도부서, 출도일자, 근원부서, 원인코드, 코드명)
        let tableHTML = `
          <table class="table table-striped">
            <thead>
              <tr>
                <th>
                  프로젝트번호
                  <button onclick="sortTable(0)" class="sort-btn">
                    <i id="sort-icon-0" class="fas fa-sort"></i>
                  </button>
                </th>
                <th>
                  출도부서
                  <button onclick="sortTable(1)" class="sort-btn">
                    <i id="sort-icon-1" class="fas fa-sort"></i>
                  </button>
                </th>
                <th>
                  출도일자
                  <button onclick="sortTable(2)" class="sort-btn">
                    <i id="sort-icon-2" class="fas fa-sort"></i>
                  </button>
                </th>
                <th>
                  근원부서
                  <button onclick="sortTable(3)" class="sort-btn">
                    <i id="sort-icon-3" class="fas fa-sort"></i>
                  </button>
                </th>
                <th>
                  원인코드
                  <button onclick="sortTable(4)" class="sort-btn">
                    <i id="sort-icon-4" class="fas fa-sort"></i>
                  </button>
                </th>
                <th>
                  코드명
                  <button onclick="sortTable(5)" class="sort-btn">
                    <i id="sort-icon-5" class="fas fa-sort"></i>
                  </button>
                </th>
              </tr>
            </thead>
       <tbody id="table-body">
  `;

        // 데이터를 순회하며 테이블 행을 추가
        data.forEach((item) => {
          // 출도일자의 시간 부분을 제거하고 날짜만 표시
          const 출도일자 = new Date(item.출도일자).toLocaleDateString("ko-KR");

          tableHTML += `
      <tr>
        <td>${item.프로젝트번호}</td>
        <td>${item.출도부서}</td>
        <td>${출도일자}</td>
        <td>${item.근원부서}</td>
        <td>${item.원인코드}</td>
        <td>${item.코드명}</td>
      </tr>
    `;
        });

        tableHTML += `
      </tbody>
    </table>
  `;
        function searchTable() {
          const input = document
            .getElementById("searchInput")
            .value.toLowerCase(); // 검색어를 소문자로 변환
          const tableBody = document.getElementById("table-body"); // 테이블 바디
          const rows = Array.from(tableBody.getElementsByTagName("tr")); // 모든 행 가져오기

          rows.forEach((row) => {
            const cells = Array.from(row.getElementsByTagName("td"));
            const rowText = cells
              .map((cell) => cell.textContent.toLowerCase())
              .join(" "); // 모든 셀의 텍스트를 결합

            // 검색어가 포함된 행은 표시하고, 포함되지 않은 행은 숨기기
            if (rowText.includes(input)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        }

        // 생성된 테이블을 section 내의 dataTableContainer에 삽입
        document.getElementById("dataTableContainer").innerHTML = tableHTML;
      }
      function searchTable() {
        const input = document
          .getElementById("searchInput")
          .value.toLowerCase(); // 검색어를 소문자로 변환
        const tableBody = document.getElementById("table-body"); // 테이블 바디
        const rows = Array.from(tableBody.getElementsByTagName("tr")); // 모든 행 가져오기

        rows.forEach((row) => {
          const cells = Array.from(row.getElementsByTagName("td"));
          const rowText = cells
            .map((cell) => cell.textContent.toLowerCase())
            .join(" "); // 모든 셀의 텍스트를 결합

          // 검색어가 포함된 행은 표시하고, 포함되지 않은 행은 숨기기
          if (rowText.includes(input)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      let originalTableData = []; // 초기 테이블 데이터를 저장할 변수

      // 서버에서 데이터를 가져와 테이블을 생성하는 함수
      function fetchDataAndCreateTable(collectionName, dbName) {
        document.querySelector(".reset-button").style.display = "block";
        document.querySelector("#searchInput").style.display = "block";
        const loadingMessage = document.getElementById("loadingMessage");
        const dataTableContainer =
          document.getElementById("dataTableContainer");
        // 경고/주의 리스트 숨기기
        document.getElementById("alert-list").style.display = "none";
        // // 차트 관련 요소를 숨김
        // document.getElementById("total-count").textContent = ""; // 총 원인코드 수 초기화
        document.getElementById("myChart").style.display = "none"; // 차트 숨기기

        // 로딩 메시지를 표시
        loadingMessage.style.display = "block";
        dataTableContainer.innerHTML = ""; // 기존 테이블 내용을 비움

        fetch(
          `/api/revised?collection=${collectionName}&db=${dbName}&type=table`
        )
          .then((response) => response.json())
          .then((data) => {
            originalTableData = [...data]; // 처음 로드된 데이터를 저장
            createTable(data); // 테이블 생성

            loadingMessage.style.display = "none";
          })

          .catch((error) => {
            console.error("Error fetching table data:", error);

            // 로딩 메시지를 숨김
            loadingMessage.style.display = "none";

            // 에러 메시지 표시 (선택 사항)
            dataTableContainer.innerHTML =
              '<p style="color:red;">데이터를 불러오는 중 오류가 발생했습니다.</p>';
          });
      }
      function resetTable() {
        createTable(originalTableData); // 초기 데이터를 이용해 테이블을 다시 생성
        sortOrder = {}; // 정렬 순서 초기화
        sortPriority = []; // 우선 순위 초기화
        updateSortIcons(); // 정렬 아이콘 초기화
      }

      function updateSortIcons() {
        document.querySelectorAll(".sort-btn i").forEach((icon) => {
          icon.classList.remove("fa-sort-up", "fa-sort-down", "active");
          icon.classList.add("fa-sort"); // 아이콘을 기본 상태로 설정
        });
      }
      // 페이지가 로드될 때 URL에 맞는 탭을 활성화
      document.addEventListener("DOMContentLoaded", function () {
        const activeTab = localStorage.getItem("activeTab");
        const currentPath = window.location.pathname;

        let tabToActivate;

        // URL 경로에 따라 적절한 탭 설정
        if (currentPath.includes("first")) {
          tabToActivate = "tab1";
        } else if (currentPath.includes("second")) {
          tabToActivate = "tab2";
        } else if (currentPath.includes("third")) {
          tabToActivate = "tab3";
        } else if (currentPath.includes("sixth")) {
          tabToActivate = "tab4";
        }

        if (tabToActivate) {
          // 모든 탭에서 active 클래스 제거
          document.querySelectorAll(".nav-link").forEach(function (tab) {
            tab.classList.remove("active");
          });
          // URL에 맞는 탭에 active 클래스 추가
          document.getElementById(tabToActivate).classList.add("active");
          localStorage.setItem("activeTab", tabToActivate); // 활성화된 탭 상태 저장
        }
      });
    </script>

    <script>
      let myChart = null;

      const title = document.getElementById("title");

      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("h5-title").innerHTML = "개정도 현황"; // h5 제목 표시

        // 페이지가 로드되면 즉시 Project_1 데이터를 출력
        fetchDataAndCreateTable("개정도_0", "개정도DB");

        // 서버에서 데이터를 가져와 차트를 그리는 함수
        function fetchDataAndCreateChart(collectionName, dbName, data_type) {
          document.querySelector(".reset-button").style.display = "none";
          document.querySelector("#searchInput").style.display = "none";
          // 서버에 요청을 보낼 때 collectionName과 dbName을 동적으로 포함
          fetch(
            `/api/revised?collection=${collectionName}&db=${dbName}&type=${data_type}`
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              const labels = data.map((item) => item._id); // 출도부서
              const counts = data.map((item) => item.count); // 원인 코드 수

              // 기준선을 넘는 데이터를 강조하기 위한 배경색 설정
              const backgroundColors = counts.map((count) => {
                if (count > 80) {
                  return "rgba(54, 162, 235, 0.8)"; // 80을 넘는 경우 투명도 0.6
                } else if (count > 50) {
                  return "rgba(54, 162, 235, 0.5)"; // 50을 넘는 경우 투명도 0.4
                } else {
                  return "rgba(54, 162, 235, 0.1)"; // 그 외 투명도 0.2
                }
              });

              const borderColors = counts.map((count) => {
                if (count > 80) {
                  return "rgba(54, 162, 235, 1)"; // 80을 넘는 경우 진한 테두리
                } else if (count > 50) {
                  return "rgba(54, 162, 235, 1)"; // 50을 넘는 경우 동일한 테두리
                } else {
                  return "rgba(54, 162, 235, 1)"; // 그 외 동일한 테두리
                }
              });

              // 기존 차트가 있다면 파괴
              if (myChart) {
                myChart.destroy();
              }

              // 차트를 생성
              const ctx = document.getElementById("myChart").getContext("2d");
              myChart = new Chart(ctx, {
                type: "bar",
                data: {
                  labels: labels,
                  datasets: [
                    {
                      data: counts,
                      backgroundColor: backgroundColors, // 동적으로 생성된 색상 배열 사용
                      borderColor: borderColors, // 동적으로 생성된 경계선 색상 배열 사용
                      borderWidth: 1,
                    },
                  ],
                },
                options: {
                  onClick: function (evt, activeElements) {
                    if (activeElements.length > 0) {
                      const index = activeElements[0].index;
                      const label = this.data.labels[index]; // 클릭한 레이블
                      console.log("Clicked on label:", label);
                      // 여기서 데이터를 처리하는 로직 추가
                    }
                  },
                  responsive: true,
                  elements: {
                    bar: {
                      borderWidth: 1,
                      hoverBorderWidth: 3, // 마우스가 올려졌을 때 막대의 테두리를 넓게 표시
                      hoverBackgroundColor: "rgba(255, 99, 132, 0.8)", // 마우스가 올려졌을 때 배경 색상 변경
                    },
                  },
                  scales: {
                    x: {
                      title: {
                        display: true,
                        text: "출도부서", // x축의 라벨
                        font: {
                          weight: "bold", // x축 라벨 폰트 굵게 설정
                          size: 15, // 폰트 크기 설정
                        },
                      },
                      ticks: {
                        color: (context) => {
                          // 기준선(50, 80)을 넘는 경우 색상 변경
                          const index = context.index;
                          const count = counts[index];

                          if (count > 80) {
                            return "red"; // 80을 넘으면 빨간색
                          } else if (count > 50) {
                            return "blue"; // 50을 넘으면 파란색
                          } else {
                            return "black"; // 그 외는 검정색
                          }
                        },
                        font: {
                          size: 12, // x축의 tick 폰트 크기 설정
                        },
                      },
                    },
                    y: {
                      title: {
                        display: true,
                        text: "원인코드 비율 (%)", // y축의 라벨
                        font: {
                          weight: "bold", // y축 라벨 폰트 굵게 설정
                          size: 15, // 폰트 크기 설정
                        },
                        align: "center",
                      },
                      type: "linear", // 로그 스케일로 설정
                      suggestedMin: 0.9,
                      ticks: {
                        font: {
                          weight: "bold", // y축 tick 폰트 굵게 설정
                          size: 12, // y축 tick 폰트 크기 설정
                        },
                        min: 1, // 최소값 설정
                      },
                    },
                  },

                  plugins: {
                    legend: {
                      display: false, // 범례를 아예 표시하지 않음
                    },
                    tooltip: {
                      // 툴팁 스타일을 조정하는 부분
                      bodyFont: {
                        size: 18, // 툴팁 내부 텍스트 크기 설정
                        weight: "bold",
                      },
                      titleFont: {
                        size: 20, // 툴팁 제목 텍스트 크기 설정
                        weight: "bold",
                      },
                      padding: 10, // 툴팁 내부 여백 조정
                      boxPadding: 10, // 툴팁 박스의 패딩을 추가
                      caretSize: 10, // 툴팁 삼각형 크기 설정
                      callbacks: {
                        title: function () {
                          return ""; // 툴팁 상단 제목을 표시하지 않도록 빈 문자열 반환
                        },
                        label: function (context) {
                          const label = context.dataset.label || "";
                          const value = context.raw;
                          return `${context.label} 부서의 원인코드 발생률 : ${value}%`; // 툴팁에 표시할 텍스트 포맷
                        },
                      },
                    },
                    annotation: {
                      annotations: {
                        line1: {
                          type: "line",
                          yMin: 80, // 선이 그려질 y축 값
                          yMax: 80, // 동일하게 설정하여 수평선 유지
                          borderColor: "red",
                          borderWidth: 1,
                        },
                        line2: {
                          type: "line",
                          yMin: 50, // 선이 그려질 y축 값
                          yMax: 50, // 동일하게 설정하여 수평선 유지
                          borderColor: "blue",
                          borderWidth: 1,
                        },
                      },
                    },
                  },
                  onClick: (e, elements) => {
                    if (elements.length > 0) {
                      const index = elements[0].index;
                      const department = labels[index]; // 클릭한 막대에 해당하는 출도부서
                      fetchDepartmentCauseCode(
                        department,
                        collectionName,
                        dbName
                      ); // 부서별 원인 코드 비율을 요청
                    }
                  },
                },
                plugins: [
                  {
                    id: "custom-text",
                    afterDatasetsDraw: (chart) => {
                      const ctx = chart.ctx;
                      ctx.save();

                      // 배경을 추가하여 텍스트를 더 잘 보이게 하기
                      const boxWidth = 100;
                      const boxHeight = 50;
                      const textPadding = 10;

                      // 배경 박스 위치 및 크기 설정
                      const xPosition =
                        chart.chartArea.right - (boxWidth + textPadding);
                      const yPosition = 10;

                      ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; // 반투명한 흰색 배경
                      ctx.fillRect(xPosition, yPosition, boxWidth, boxHeight); // 배경 박스

                      ctx.font = "bold 14px Arial";
                      ctx.textAlign = "center"; // 텍스트를 박스 중앙에 정렬
                      const xCenter = xPosition + boxWidth / 2; // 가운데 위치

                      // 텍스트 표시
                      ctx.fillStyle = "red";
                      ctx.fillText("경고 (80% 이상)", xCenter, yPosition + 20); // 텍스트 위치
                      ctx.fillStyle = "blue";
                      ctx.fillText("주의 (50% 이상)", xCenter, yPosition + 40);

                      ctx.restore();
                    },
                  },
                ],
              });

              // 경고 및 주의 부서 리스트 초기화
              const warningDepartments = [];
              const cautionDepartments = [];

              labels.forEach((label, index) => {
                const count = counts[index];
                if (count > 80) {
                  warningDepartments.push(label); // 80개 초과: 경고 부서
                } else if (count > 50) {
                  cautionDepartments.push(label); // 50개 초과: 주의 부서
                }
              });

              // 경고 부서 리스트 업데이트
              const warningListElement = document.getElementById(
                "warning-departments"
              );
              warningListElement.innerHTML = warningDepartments
                .map((dept) => `<li>${dept}</li>`)
                .join("");

              // 주의 부서 리스트 업데이트
              const cautionListElement = document.getElementById(
                "caution-departments"
              );
              cautionListElement.innerHTML = cautionDepartments
                .map((dept) => `<li>${dept}</li>`)
                .join("");

              // 경고/주의 부서 개수 업데이트
              document.getElementById(
                "warning-count"
              ).textContent = `경고부서 : ${warningDepartments.length}개`;
              document.getElementById(
                "caution-count"
              ).textContent = `주의부서 : ${cautionDepartments.length}개`;

              // 경고/주의 리스트 보이기
              document.getElementById("alert-list").style.display = "block";

              // 차트 데이터 설정 및 생성...
            })
            .catch((error) => {
              console.error("Error fetching data:", error);
            });
        }

        let collectionName = "";
        let dbName = "";
        let data_type = "";

        // 클릭된 부서의 원인 코드 비율을 가져오는 함수

        function fetchDepartmentCauseCode(department, collectionName, dbName) {
          document.getElementById("total-count").textContent = "";
          fetch(
            `/api/department-cause-code?department=${department}&collection=${collectionName}&db=${dbName}`
          )
            .then((response) => response.json())
            .then((data) => {
              const causeCodeNames = {
                R1: "RNAME20",
                R10: "RNAME11",
                R11: "RNAME15",
                R12: "RNAME13",
                R13: "RNAME7",
                R14: "RNAME10",
                R15: "RNAME18",
                R16: "RNAME5",
                R17: "RNAME14",
                R18: "RNAME2",
                R19: "RNAME1",
                R2: "RNAME9",
                R3: "RNAME4",
                R4: "RNAME17",
                R5: "RNAME8",
                R6: "RNAME6",
                R7: "RNAME12",
                R8: "RNAME3",
                R9: "RNAME19",
              };

              const labels = data.map((item) => {
                const causeCode = item._id; // 원인코드는 _id
                const causeName = causeCodeNames[causeCode] || "No Name"; // 매핑된 코드명
                return `${causeCode} (${causeName})`;
              });
              const counts = data.map((item) => item.count); // 개수
              const total = counts.reduce((acc, count) => acc + count, 0); // 총 개수

              // 파이 차트 설정
              const ctx = document.getElementById("myChart").getContext("2d");

              if (myChart) {
                myChart.destroy();
              }

              myChart = new Chart(ctx, {
                type: "pie",
                data: {
                  labels: labels,
                  datasets: [
                    {
                      label: `${department} 부서의 원인 코드 비율`,
                      data: counts,
                      backgroundColor: [
                        "rgba(255, 99, 132, 0.2)",
                        "rgba(54, 162, 235, 0.2)",
                        "rgba(255, 206, 86, 0.2)",
                      ],
                      borderColor: [
                        "rgba(255, 99, 132, 1)",
                        "rgba(54, 162, 235, 1)",
                        "rgba(255, 206, 86, 1)",
                      ],
                      borderWidth: 1,
                    },
                  ],
                },
                options: {
                  plugins: {
                    legend: {
                      labels: {
                        font: {
                          size: 16, // 범례 텍스트 크기 설정
                        },
                      },
                    },
                    datalabels: {
                      display: (context) => {
                        const value = context.dataset.data[context.dataIndex];
                        const percentage = value / total;
                        return percentage >= 0.05; // 데이터 비율이 5% 이상인 경우만 표시
                      },
                      color: "black",
                      font: {
                        size: 14, // 데이터 레이블 텍스트 크기 설정
                      },
                      formatter: (value, context) => {
                        const label =
                          context.chart.data.labels[context.dataIndex];
                        const percentage = ((value / total) * 100).toFixed(2);
                        return `${label} : ${value}개 (${percentage}%)`;
                      },
                    },
                    tooltip: {
                      bodyFont: {
                        size: 12, // 툴팁 텍스트 크기 설정
                      },
                      callbacks: {
                        title: () => {
                          return ""; // 타이틀을 제거하기 위해 빈 배열 반환
                        },
                        label: (tooltipItem) => {
                          const label = tooltipItem.label;
                          const value = tooltipItem.raw;
                          const percentage = ((value / total) * 100).toFixed(2);
                          return `원인코드 ${label} : ${value}개 (${percentage}%)`;
                        },
                      },
                    },
                  },
                },
                plugins: [ChartDataLabels], // 플러그인 사용
              });

              // 원인코드 총 개수 출력
              document.getElementById(
                "total-count"
              ).textContent = `${department} 부서의 총 원인코드 수: ${total}`;

              // 파이 차트를 표시할 때 경고/주의 리스트 숨기기
              document.getElementById("alert-list").style.display = "none";
            })
            .catch((error) => {
              console.error(
                "Error fetching department cause code data:",
                error
              );
            });
        }

        // 모든 collection-link 클래스에 클릭 이벤트 추가
        document.querySelectorAll(".collection-link").forEach((link) => {
          link.addEventListener("click", function (event) {
            event.preventDefault(); // 기본 동작 방지

            // total-count 초기화
            document.getElementById("total-count").textContent = "";

            collectionName = this.getAttribute("data-collection");
            dbName = this.getAttribute("data-db");
            data_type = this.getAttribute("data-type");

            if (data_type === "chart") {
              // 테이블 제거 및 h5와 차트 표시
              document.getElementById("dataTableContainer").innerHTML = ""; // 테이블 제거
              document.getElementById("h5-title").innerHTML =
                "출도부서별 원인코드 발생율"; // h5 제목 표시
              document.getElementById("myChart").style.display = "block"; // 차트 표시

              fetchDataAndCreateChart(collectionName, dbName, data_type); // 차트 데이터 불러오기
            } else if (data_type === "table") {
              // 차트 제거 및 테이블 표시
              document.getElementById("myChart").style.display = "none"; // 차트 숨기기
              document.getElementById("h5-title").innerHTML = "개정도 현황"; // h5 제목 숨기기

              fetchDataAndCreateTable(collectionName, dbName); // 테이블 데이터 불러오기
            }
          });
        });
      });

      let sortOrder = {}; // 각 열별 정렬 순서를 기억할 객체
      let sortPriority = []; // 우선 순위별로 정렬할 열을 저장하는 배열

      function sortTable(columnIndex) {
        const tableBody = document.getElementById("table-body");
        const rows = Array.from(tableBody.rows); // 모든 테이블 행을 배열로 변환

        // 정렬 상태 순환 (0: 정렬 안 함, 1: 오름차순, 2: 내림차순)
        if (!sortOrder[columnIndex]) {
          sortOrder[columnIndex] = 1; // 첫 번째 클릭: 오름차순
        } else if (sortOrder[columnIndex] === 1) {
          sortOrder[columnIndex] = 2; // 두 번째 클릭: 내림차순
        } else {
          sortOrder[columnIndex] = 0; // 세 번째 클릭: 정렬 풀기
          // 정렬 풀기 상태라면 우선순위 배열에서 제거
          sortPriority = sortPriority.filter((index) => index !== columnIndex);
          updateSortIcons(); // 정렬 상태 업데이트
          // 기존 정렬된 열에 따라 테이블을 다시 정렬
          if (sortPriority.length > 0) {
            reSortTable(); // 남은 우선순위대로 재정렬
          } else {
            // 우선순위가 없으면 원래 순서로 테이블을 초기화할 수도 있음
            resetTable();
          }
          return;
        }

        // 클릭된 열을 우선 순위에 추가하기 전에 중복 제거
        sortPriority = sortPriority.filter((index) => index !== columnIndex);
        sortPriority.push(columnIndex); // 새로 클릭한 열을 우선 순위 맨 뒤에 추가

        // 우선 순위 배열의 순서대로 정렬
        rows.sort((a, b) => {
          for (let i = 0; i < sortPriority.length; i++) {
            const colIndex = sortPriority[i];
            const cellA = a.cells[colIndex].innerText.trim();
            const cellB = b.cells[colIndex].innerText.trim();

            let valueA, valueB;

            // 출도일자 열(columnIndex === 2)일 경우
            if (colIndex === 2) {
              // 출도일자 문자열을 Date 객체로 변환
              valueA = new Date(cellA);
              valueB = new Date(cellB);
            } else {
              // 다른 열은 기존 방식대로 숫자만 추출: D112 -> 112, D23 -> 23
              valueA = parseFloat(cellA.replace(/[^\d]/g, "")) || cellA;
              valueB = parseFloat(cellB.replace(/[^\d]/g, "")) || cellB;
            }

            if (valueA !== valueB) {
              // 현재 열의 정렬 순서에 따라 오름차순/내림차순 결정
              if (sortOrder[colIndex] === 1) {
                return valueA > valueB ? 1 : -1; // 오름차순
              } else if (sortOrder[colIndex] === 2) {
                return valueA < valueB ? 1 : -1; // 내림차순
              }
            }
          }
          return 0; // 동일한 경우 다음 열로 넘어감
        });

        // 정렬된 순서대로 테이블에 다시 추가
        tableBody.innerHTML = "";
        rows.forEach((row) => tableBody.appendChild(row));

        // 아이콘 업데이트
        updateSortIcons();
      }

      function updateSortIcons() {
        // 모든 아이콘을 기본 상태로 설정
        document.querySelectorAll(".sort-btn i").forEach((icon) => {
          icon.classList.remove("fa-sort-up", "fa-sort-down", "active");
          icon.classList.add("fa-sort");
        });

        // 우선 순위별로 아이콘을 업데이트
        sortPriority.forEach((columnIndex) => {
          const sortIcon = document.getElementById(`sort-icon-${columnIndex}`);
          sortIcon.classList.remove("fa-sort");

          if (sortOrder[columnIndex] === 1) {
            sortIcon.classList.add("fa-sort-up", "active"); // 오름차순 아이콘
          } else if (sortOrder[columnIndex] === 2) {
            sortIcon.classList.add("fa-sort-down", "active"); // 내림차순 아이콘
          }
        });
      }

      function reSortTable() {
        const tableBody = document.getElementById("table-body");
        const rows = Array.from(tableBody.rows);

        rows.sort((a, b) => {
          for (let i = 0; i < sortPriority.length; i++) {
            const colIndex = sortPriority[i];
            const cellA = a.cells[colIndex].innerText.trim();
            const cellB = b.cells[colIndex].innerText.trim();

            const valueA = parseFloat(cellA.replace(/[^\d]/g, "")) || cellA;
            const valueB = parseFloat(cellB.replace(/[^\d]/g, "")) || cellB;

            if (valueA !== valueB) {
              if (sortOrder[colIndex] === 1) {
                return valueA > valueB ? 1 : -1;
              } else if (sortOrder[colIndex] === 2) {
                return valueA < valueB ? 1 : -1;
              }
            }
          }
          return 0;
        });

        tableBody.innerHTML = "";
        rows.forEach((row) => tableBody.appendChild(row));
      }

      let selectedLink = null;
      document.querySelectorAll(".collection-link").forEach(function (link) {
        link.addEventListener("click", function (event) {
          event.preventDefault();

          // 이전에 선택된 링크가 있으면 selected 클래스를 제거
          if (selectedLink) {
            selectedLink.classList.remove("selected");
          }

          // 새로 클릭된 링크에 selected 클래스를 추가하고 현재 선택된 링크로 설정
          link.classList.add("selected");
          selectedLink = link;
        });
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"
      integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  </body>
</html>
